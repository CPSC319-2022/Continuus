#!/bin/bash

# $1: Cloud Build Trigger ID
# $2: Branch Name
# $3: Stage Name

trigger_output=$(gcloud builds triggers run $1 --branch=$2 --format="json")

build_id=$(echo $trigger_output | jq -r '.metadata."build"."id"')
log_url=$(echo $trigger_output | jq -r '.metadata."build"."logUrl"')

echo "$3 stage started for branch $2"
echo "Google Cloud Build ID: $build_id"
echo "Logs: $log_url"

gcloud builds log --stream "$build_id"
describe_output=$(gcloud builds describe $build_id --format="json")
status=$(echo $describe_output | jq -r '.status')

if [[ "$3" == *"Test"* ]]; then
  echo "Test results:"
  gcloud logging read "resource.labels.build_id=$build_id" | grep -o "textPayload: 'Step #1.*" | cut -f3- -d: | sed 's/.$//'
fi

if [[ $status == "SUCCESS" ]]; then
  echo "Build succeeded!"
  exit 0
elif [[ $status == "FAILED" ]]; then
  echo "Build failed. See logs: $log_url"
else
  echo "Build failed (status $status). Check build logs: $log_url"
fi

exit 1
